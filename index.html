<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>M.O.G. | MANIFEST</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root { 
            --gold: #D4AF37; 
            --gold-bright: #f3cf5a;
            --bg: #050505; 
            --panel: rgba(15, 15, 15, 0.8); 
        }

        body { 
            background-color: var(--bg); 
            color: #fff; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden;
            height: 100vh;
        }

        .serif { font-family: 'Cinzel', serif; }
        
        /* Smooth Gold Gradient Text */
        .gold-text { 
            background: linear-gradient(180deg, #fff 0%, var(--gold) 100%); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            filter: drop-shadow(0 0 5px rgba(212, 175, 55, 0.3));
        }

        /* Improved Glassmorphism */
        .glass-tile { 
            background: var(--panel); 
            border: 1px solid rgba(212, 175, 55, 0.1); 
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1); 
            cursor: pointer; 
            border-radius: 2px; 
            position: relative;
            overflow: hidden;
        }

        .glass-tile::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.1), transparent);
            transition: 0.5s;
        }

        .glass-tile:hover::before { left: 100%; }

        .glass-tile:hover { 
            border-color: var(--gold); 
            transform: translateY(-2px); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.5), 0 0 15px rgba(212, 175, 55, 0.1);
        }

        /* Modal Polish */
        .modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.9); 
            z-index: 200; 
            backdrop-filter: blur(20px); 
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal.active { display: flex; opacity: 1; align-items: center; justify-content: center; }

        .modal-content { 
            background: #080808; 
            border: 1px solid rgba(212, 175, 55, 0.5); 
            max-width: 400px; 
            width: 90%; 
            padding: 3rem 2rem; 
            position: relative;
        }

        /* QR Code Container Styling */
        #qrcode { 
            padding: 10px; 
            background: #fff; 
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(255,255,255,0.1);
        }

        input { 
            background: rgba(255,255,255,0.03) !important; 
            border: 1px solid rgba(212, 175, 55, 0.2) !important; 
            color: #fff !important; 
            text-align: center; 
            padding: 16px; 
            margin-bottom: 12px; 
            width: 100%; 
            letter-spacing: 2px;
            transition: 0.3s;
        }
        input:focus { border-color: var(--gold) !important; background: rgba(255,255,255,0.08) !important; }

        .loading-shimmer {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(to right, #D4AF37 0%, #fff 50%, #D4AF37 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @keyframes shimmer { to { background-position: 200% center; } }
    </style>
</head>
<body>

    <div id="ritual-overlay" class="fixed inset-0 bg-black z-[999] flex flex-col justify-center align-center items-center pointer-events-none transition-opacity duration-1000">
        <div class="text-[10px] tracking-[0.5em] text-gold uppercase opacity-60 font-mono animate-pulse">> ESTABLISHING SECURE CONNECTION...</div>
    </div>

    <video id="video-bg" class="fixed inset-0 z-[-1] w-full h-full object-cover opacity-20 grayscale" autoplay muted loop playsinline>
        <source src="1000211769.mp4" type="video/mp4">
    </video>

    <nav class="fixed top-0 w-full p-6 flex justify-between items-center z-50">
        <div class="serif text-xl gold-text tracking-widest cursor-pointer hover:opacity-80" onclick="location.reload()">M.O.G.</div>
        <div id="status-indicator" class="flex items-center gap-2">
            <span class="text-[8px] text-zinc-500 uppercase tracking-widest">System Live</span>
            <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_#10b981]"></div>
        </div>
    </nav>

    <main class="relative z-10 pt-32 px-6 max-w-md mx-auto text-center">
        <div class="relative inline-block mb-8">
            <div class="absolute inset-0 rounded-full border border-gold/20 animate-ping"></div>
            <img src="logo.png" class="w-20 h-20 rounded-full border border-gold/30 shadow-2xl relative z-10">
        </div>
        
        <h1 class="serif text-6xl gold-text mb-2 italic">MANIFEST</h1>
        <p class="text-[9px] tracking-[0.6em] text-zinc-500 mb-12 uppercase font-light">Sovereign Identity Protocol</p>

        <div class="grid grid-cols-2 gap-4">
            <div onclick="openNode('auth')" class="glass-tile py-8">
                <div class="text-[9px] tracking-[0.3em] uppercase font-bold text-gold">Access Node</div>
            </div>
            <div onclick="openNode('vault')" class="glass-tile py-8">
                <div class="text-[9px] tracking-[0.3em] uppercase font-bold text-zinc-500">Vault</div>
            </div>
            <div onclick="openNode('crew')" class="glass-tile py-8">
                <div class="text-[9px] tracking-[0.3em] uppercase font-bold text-zinc-500">Crew</div>
            </div>
            <div onclick="openNode('command')" class="glass-tile py-8">
                <div class="text-[9px] tracking-[0.3em] uppercase font-bold text-zinc-500">Command</div>
            </div>
        </div>
    </main>

    <div id="node-modal" class="modal" onclick="if(event.target === this) closeNode()">
        <div class="modal-content">
            <span class="close-btn absolute top-6 right-8 text-zinc-600 hover:text-gold cursor-pointer text-2xl" onclick="closeNode()">&times;</span>
            <h2 id="modal-title" class="serif text-2xl gold-text mb-4 italic"></h2>
            <div id="modal-body" class="mb-6 text-zinc-400 text-[10px] uppercase tracking-widest leading-relaxed"></div>
            <div id="modal-action" class="flex flex-col gap-2"></div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            S_URL: 'https://nwaridsuoqxdunfimele.supabase.co',
            S_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53YXJpZHN1b3F4ZHVuZmltZWxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNzk2MzgsImV4cCI6MjA4NTg1NTYzOH0.tVYmN3lq7bbpgggX0AOVOqW88Y2Q0cvGSpmo3CW3KeE'
        };

        const supabase = window.supabase.createClient(CONFIG.S_URL, CONFIG.S_KEY);
        let currentUser = null;

        // Initialization
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('ritual-overlay').style.opacity = '0';
            }, 2000);
            initSession();
        });

        async function initSession() {
            const { data, error } = await supabase.auth.signInAnonymously();
            if (error) console.error("Auth Error:", error);
            currentUser = data.user;
        }

        // Modal Logic
        function openNode(id) {
            const modal = document.getElementById('node-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            const action = document.getElementById('modal-action');

            modal.classList.add('active');

            if (id === 'auth') {
                title.innerText = "IDENTITY VERIFICATION";
                body.innerHTML = "<span class='loading-shimmer'>Scanning database...</span>";
                action.innerHTML = "";
                checkMemberStatus();
            } else {
                title.innerText = id.toUpperCase();
                body.innerText = "Level 2 clearance required. Node currently encrypted.";
                action.innerHTML = `<button onclick="closeNode()" class="border border-zinc-800 text-zinc-500 py-4 text-[10px] tracking-widest hover:bg-zinc-900">RETURN</button>`;
            }
        }

        function closeNode() { 
            document.getElementById('node-modal').classList.remove('active'); 
        }

        // Auth Logic
        async function checkMemberStatus() {
            try {
                const { data: op, error } = await supabase.from('operatives').select('*').eq('id', currentUser.id).single();
                if (op) {
                    renderID(op.alias, op.id);
                } else {
                    showPortal();
                }
            } catch (e) {
                showPortal();
            }
        }

        function showPortal() {
            document.getElementById('modal-body').innerText = "Submit your alias to the manifest";
            document.getElementById('modal-action').innerHTML = `
                <input type="text" id="alias-input" placeholder="OPERATIVE ALIAS" maxlength="15">
                <button onclick="handleAuth('REGISTER')" class="bg-[#D4AF37] text-black font-black py-4 text-[10px] tracking-[0.2em] hover:bg-white transition-colors">INITIATE REGISTRATION</button>
                <button onclick="handleAuth('LOGIN')" class="border border-[#D4AF37] text-[#D4AF37] py-4 text-[10px] tracking-[0.2em] hover:bg-[#D4AF37] hover:text-black transition-all">RECALL IDENTITY</button>
            `;
        }

        async function handleAuth(mode) {
            const aliasInput = document.getElementById('alias-input');
            const alias = aliasInput.value.trim().toUpperCase();
            
            if (!alias || alias.length < 3) return alert("ALIAS TOO SHORT (MIN 3)");

            const btn = event.target;
            btn.innerText = "PROCESSING...";
            btn.disabled = true;

            const { data: existing } = await supabase.from('operatives').select('*').eq('alias', alias).single();

            if (mode === 'REGISTER') {
                if (existing) {
                    alert("ALIAS UNAVAILABLE");
                    btn.innerText = "INITIATE REGISTRATION";
                    btn.disabled = false;
                    return;
                }
                const { error } = await supabase.from('operatives').insert([{ id: currentUser.id, alias: alias }]);
                if (!error) renderID(alias, currentUser.id);
            } else {
                if (!existing) {
                    alert("IDENTITY UNKNOWN");
                    btn.innerText = "RECALL IDENTITY";
                    btn.disabled = false;
                    return;
                }
                // Update the current anonymous user ID to the found record
                await supabase.from('operatives').update({ id: currentUser.id }).eq('alias', alias);
                renderID(existing.alias, existing.id);
            }
        }

        function renderID(name, id) {
            document.getElementById('modal-body').innerHTML = `
                <div class="flex justify-center mb-6">
                    <div id="qrcode"></div>
                </div>
                <div class="gold-text text-3xl font-bold italic mb-1 tracking-tighter">${name}</div>
                <div class="text-[7px] opacity-30 font-mono tracking-widest">SECURE_TOKEN: ${id}</div>
            `;
            
            document.getElementById('modal-action').innerHTML = `
                <button onclick="downloadPass('${name}')" class="bg-white text-black font-bold py-4 text-[10px] tracking-widest hover:bg-gold transition-colors">DOWNLOAD CLEARANCE PASS</button>
                <button onclick="logout()" class="text-[8px] text-zinc-600 uppercase mt-4 tracking-[0.3em] hover:text-red-900 transition-colors">Terminate Session</button>
            `;

            new QRCode(document.getElementById("qrcode"), { 
                text: id, 
                width: 140, 
                height: 140,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        function downloadPass(name) {
            const canvas = document.querySelector('#qrcode canvas');
            const link = document.createElement('a');
            link.download = `MOG_ID_${name}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        }

        function logout() { 
            if(confirm("TERMINATE SESSION?")) location.reload(); 
        }
    </script>
</body>
</html>
